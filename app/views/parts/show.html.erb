<div class="card border-0 shadow-sm rounded-3 p-3 mb-4">
    <div class="card-body">
        <h1 class="card-title h3 mb-4">Part: <%= @part.part_name %></h1>

        <!-- Part Details -->
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0">Part Details</h2>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Part Number:</strong> <%= @part.part_number %></p>
                <p class="mb-1"><strong>Part Name:</strong> <%= @part.part_name %></p>
                <p class="mb-1"><strong>Material:</strong> <%= @part.material %></p>
                <p class="mb-1"><strong>Nominal Size:</strong> <%= @part.nominal_size %></p>
                <p class="mb-1"><strong>Part Name (English):</strong> <%= @part.part_name_eg %></p>
                <p class="mb-1"><strong>Quantity:</strong> <%= @part.quantity %></p>
                <p class="mb-3"><strong>Description:</strong> <%= @part.description %></p>
                <% if @part.image.attached? %>
                <div class="mb-3">
                    <strong>Image:</strong>
                    <div class="mt-2">
                        <%= image_tag @part.image, class: "img-fluid rounded", alt: @part.part_name %>
                    </div>
                </div>
                <% end %>
            </div>
        </div>


        <!-- Related Versions -->
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Related Versions</h2>
                <%= link_to 'New Version', new_part_version_path(@part), class: "btn btn-sm btn-outline-primary" %>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    <% @part.versions.each do |version| %>
                    <li class="list-group-item">
                        <%= link_to version.version_number, version, class: "text-decoration-none" %>
                        <small class="text-muted d-block">Description: <%= truncate(version.description, length: 100) %></small>
                    </li>
                    <% end %>
                </ul>
            </div>
        </div>

        <!-- Related Blocks -->
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0">Related Blocks</h2>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    <% @part.blocks.each do |block| %>
                    <li class="list-group-item">
                        <%= link_to block.block_name, block, class: "text-decoration-none" %>
                        <small class="text-muted d-block">Block Number: <%= block.block_number %></small>
                    </li>
                    <% end %>
                </ul>
            </div>
        </div>

        <!-- Current Related Parts -->
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0">Current Related Parts</h2>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    <% @related_parts.each do |related_part| %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <%= link_to related_part.part_name, related_part, class: "text-decoration-none" %>
                            <small class="text-muted d-block">Part Number: <%= related_part.part_number %></small>
                        </div>
                        <%= button_to 'Remove', remove_related_part_part_path(@part, related_part_id: related_part.id), method: :delete, class: "btn btn-sm btn-outline-danger", data: { confirm: 'Are you sure?' } %>
                    </li>
                    <% end %>
                </ul>
            </div>
        </div>

        <!-- Add Related Part (Table Format with Action Column) -->
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0">Add Related Part</h2>
            </div>
            <div class="card-body">
                <!-- 検索入力 -->
                <div class="mb-3">
                    <label for="related-part-search" class="form-label">Search Parts:</label>
                    <input type="text" id="related-part-search" class="form-control" placeholder="Type to search...">
                </div>
                <!-- テーブル -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="related-parts-table">
                        <thead class="table-light">
                            <tr>
                                <th>Part Name</th>
                                <th>Image</th>
                                <th>Part Number</th>
                                <th>Material</th>
                                <th>Nominal Size</th>
                                <th>Quantity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <%# 自分自身および既に関連している部品は除外 %>
                            <% Part.where.not(id: @part.id).where.not(id: @related_parts.pluck(:id)).each do |p| %>
                            <tr>
                                <td><%= p.part_name %></td>
                                <td>
                                    <% if p.image.attached? %>
                                    <%= image_tag p.image.variant(resize_to_limit: [50,50]), class: "img-thumbnail" %>
                                    <% else %>
                                    <span class="text-muted">No Image</span>
                                    <% end %>
                                </td>
                                <td><%= p.part_number %></td>
                                <td><%= p.material %></td>
                                <td><%= p.nominal_size %></td>
                                <td><%= p.quantity %></td>
                                <td>
                                    <%= button_to "Add", add_related_part_part_path(@part, related_part_id: p.id), method: :post, class: "btn btn-sm btn-outline-primary", data: { confirm: "Add this related part?" } %>
                                </td>
                            </tr>
                            <% end %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <%= link_to 'Edit', edit_part_path(@part), class: "btn btn-outline-primary" %>
            <%= link_to 'Back to Parts', parts_path, class: "btn btn-outline-primary" %>
            <%= button_to 'Delete', @part, method: :delete, data: { confirm: 'Are you sure you want to delete this part?' }, class: "btn btn-outline-danger" %>
        </div>
    </div>
</div>